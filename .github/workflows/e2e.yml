name: "cypress-e2e"

on:
  workflow_dispatch:
  push:
    branches: ["**"]
  pull_request:

jobs:
  e2e:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies (including axios)
        # Dodajemy instalację axios, który jest potrzebny do komunikacji API
        run: npm ci && npm install axios

      - name: Run Cypress tests
        # Pamiętaj, aby Cypress był skonfigurowany do generowania results.xml
        run: npx cypress run --reporter junit --reporter-options "mochaFile=cypress/results/results.xml"

      - name: Upload JUnit artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-artifact
          path: cypress/results/results.xml

      - name: Upload JUnit report to Xray
        # Używamy if: always() aby wysłać raport nawet jeśli testy nie powiodły się
        if: always()
        env:
          XRAY_CLIENT_ID: ${{ secrets.XRAY_CLIENT_ID }}
          XRAY_CLIENT_SECRET: ${{ secrets.XRAY_CLIENT_SECRET }}
          PROJECT_KEY: ${{ vars.PROJECT_KEY }}
          TEST_EXEC_KEY: ${{ vars.TEST_EXEC_KEY }}
        run: |
          # Ścieżki i URL-e (zgodne z Twoją działającą konfiguracją)
          XRAY_AUTH_URL="https://xray.cloud.getxray.app/api/v2/authenticate"
          XRAY_IMPORT_URL="https://xray.cloud.getxray.app/api/v2/import/execution/junit"
          JUNIT_FILE_PATH="cypress/results/results.xml"

          # 1. Tworzenie i wykonywanie skryptu Node.js
          node -e "
          const axios = require('axios');
          const fs = require('fs');

          async function getXrayToken() {
            try {
              const authResponse = await axios.post(
                '${{ env.XRAY_AUTH_URL }}',
                { client_id: '${{ env.XRAY_CLIENT_ID }}', client_secret: '${{ env.XRAY_CLIENT_SECRET }}' },
                { headers: { 'Content-Type': 'application/json' } }
              );
              return authResponse.data.replace(/\"/g, ''); 
            } catch (error) {
              console.error('Błąd autoryzacji Xray. Sprawdź sekrety.');
              throw error;
            }
          }

          async function uploadJUnitReport(token) {
            if (!fs.existsSync('${{ env.JUNIT_FILE_PATH }}')) {
              console.error('Plik XML nie znaleziony. Anulowanie uploadu.');
              return;
            }

            const junitXml = fs.readFileSync('${{ env.JUNIT_FILE_PATH }}', 'utf-8');
            const uploadUrl = '${{ env.XRAY_IMPORT_URL }}?projectKey=${{ env.PROJECT_KEY }}&testExecKey=${{ env.TEST_EXEC_KEY }}';

            try {
              const uploadResponse = await axios.post(
                uploadUrl,
                junitXml, 
                {
                  headers: {
                    'Content-Type': 'text/xml',
                    'Authorization': 'Bearer ' + token
                  }
                }
              );

              console.log('✅ Xray Upload Sukces! Status: ' + uploadResponse.status);
              console.log('Wynik: ' + JSON.stringify(uploadResponse.data));

            } catch (error) {
              console.error('❌ Błąd uploadu do Xray.');
              console.error('Status: ' + (error.response?.status || error.message));
              console.error('Błąd Xray: ' + JSON.stringify(error.response?.data));
              process.exit(1);
            }
          }

          async function main() {
            const token = await getXrayToken();
            await uploadJUnitReport(token);
          }

          main();
          "